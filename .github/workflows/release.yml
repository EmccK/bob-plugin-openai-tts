name: Build and Release Bob Plugin

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          echo "TAG_NAME=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
        
    - name: Update version in info.json
      run: |
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        VERSION_NUMBER="${VERSION#v}"
        sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION_NUMBER\"/" info.json
        
    - name: Create plugin package
      run: |
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        mkdir -p temp_plugin
        
        # å¤åˆ¶å¿…è¦æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
        cp info.json temp_plugin/
        cp main.js temp_plugin/
        
        # åˆ›å»ºzipæ–‡ä»¶
        cd temp_plugin
        zip -r ../bob-plugin-openai-tts.zip .
        cd ..
        
        # é‡å‘½åä¸º.bobpluginæ‰©å±•å
        mv bob-plugin-openai-tts.zip bob-plugin-openai-tts.bobplugin
        
    - name: Generate SHA256
      id: sha256
      run: |
        SHA256=$(sha256sum bob-plugin-openai-tts.bobplugin | cut -d' ' -f1)
        echo "SHA256=$SHA256" >> $GITHUB_OUTPUT
        echo "Plugin SHA256: $SHA256"
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.TAG_NAME }}
        name: OpenAI TTS Plugin ${{ steps.get_version.outputs.VERSION }}
        body: |
          ## OpenAI TTS Plugin ${{ steps.get_version.outputs.VERSION }}

          ### åŠŸèƒ½ç‰¹æ€§
          - æ”¯æŒ OpenAI TTS API
          - æ”¯æŒå¤šç§è¯­éŸ³æ¨¡å‹ (tts-1, tts-1-hd, gpt-4o-mini-tts)
          - æ”¯æŒå¤šç§é¢„è®¾å£°éŸ³å’Œè‡ªå®šä¹‰å£°éŸ³
          - æ”¯æŒè‡ªå®šä¹‰æ¨¡å‹
          - æ”¯æŒè¯­éŸ³æç¤ºè¯ (prompt)
          - æ”¯æŒè‡ªå®šä¹‰ API Base URL

          ### å®‰è£…æ–¹æ³•
          1. ä¸‹è½½ `bob-plugin-openai-tts.bobplugin` æ–‡ä»¶
          2. åŒå‡»æ–‡ä»¶å®‰è£…åˆ° Bob
          3. åœ¨ Bob è®¾ç½®ä¸­é…ç½® OpenAI API Key

          ### æ–‡ä»¶ä¿¡æ¯
          - **æ–‡ä»¶å**: bob-plugin-openai-tts.bobplugin
          - **SHA256**: ${{ steps.sha256.outputs.SHA256 }}
          - **æœ€ä½ Bob ç‰ˆæœ¬**: 1.8.0

          ### æ›´æ–°æ—¥å¿—
          è¯·æŸ¥çœ‹ commit å†å²äº†è§£è¯¦ç»†æ›´æ”¹ã€‚
        files: |
          bob-plugin-openai-tts.bobplugin
        draft: false
        prerelease: false
        
    - name: Output release info
      run: |
        echo "âœ… Release created successfully!"
        echo "ğŸ“¦ Plugin file: bob-plugin-openai-tts.bobplugin"
        echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.TAG_NAME }}"
        echo "ğŸ” SHA256: ${{ steps.sha256.outputs.SHA256 }}"
