name: Build and Release Bob Plugin

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write
  actions: read

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          echo "TAG_NAME=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
        
    - name: Update version in info.json
      run: |
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        VERSION_NUMBER="${VERSION#v}"
        sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION_NUMBER\"/" info.json
        
    - name: Create plugin package
      run: |
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        mkdir -p temp_plugin
        
        # å¤åˆ¶å¿…è¦æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
        cp info.json temp_plugin/
        cp main.js temp_plugin/
        
        # åˆ›å»ºzipæ–‡ä»¶
        cd temp_plugin
        zip -r ../bob-plugin-openai-tts.zip .
        cd ..
        
        # é‡å‘½åä¸º.bobpluginæ‰©å±•å
        mv bob-plugin-openai-tts.zip bob-plugin-openai-tts.bobplugin
        
    - name: Generate SHA256
      id: sha256
      run: |
        SHA256=$(sha256sum bob-plugin-openai-tts.bobplugin | cut -d' ' -f1)
        echo "SHA256=$SHA256" >> $GITHUB_OUTPUT
        echo "Plugin SHA256: $SHA256"
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.TAG_NAME }}
        name: OpenAI TTS Plugin ${{ steps.get_version.outputs.VERSION }}
        body: |
          ## OpenAI TTS Plugin ${{ steps.get_version.outputs.VERSION }}

          ### åŠŸèƒ½ç‰¹æ€§
          - æ”¯æŒ OpenAI TTS API
          - æ”¯æŒå¤šç§è¯­éŸ³æ¨¡å‹ (tts-1, tts-1-hd, gpt-4o-mini-tts)
          - æ”¯æŒå¤šç§é¢„è®¾å£°éŸ³å’Œè‡ªå®šä¹‰å£°éŸ³
          - æ”¯æŒè‡ªå®šä¹‰æ¨¡å‹
          - æ”¯æŒè¯­éŸ³æç¤ºè¯ (prompt)
          - æ”¯æŒè‡ªå®šä¹‰ API Base URL

          ### å®‰è£…æ–¹æ³•
          1. ä¸‹è½½ `bob-plugin-openai-tts.bobplugin` æ–‡ä»¶
          2. åŒå‡»æ–‡ä»¶å®‰è£…åˆ° Bob
          3. åœ¨ Bob è®¾ç½®ä¸­é…ç½® OpenAI API Key

          ### æ–‡ä»¶ä¿¡æ¯
          - **æ–‡ä»¶å**: bob-plugin-openai-tts.bobplugin
          - **SHA256**: ${{ steps.sha256.outputs.SHA256 }}
          - **æœ€ä½ Bob ç‰ˆæœ¬**: 1.8.0

          ### æ›´æ–°æ—¥å¿—
          è¯·æŸ¥çœ‹ commit å†å²äº†è§£è¯¦ç»†æ›´æ”¹ã€‚
        files: |
          bob-plugin-openai-tts.bobplugin
        draft: false
        prerelease: false

    - name: Update appcast.json
      run: |
        # è·å–å½“å‰æ—¶é—´æˆ³ (æ¯«ç§’)
        TIMESTAMP=$(date +%s)000

        # è·å–ç‰ˆæœ¬å· (å»æ‰vå‰ç¼€)
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        VERSION_NUMBER="${VERSION#v}"

        # æ„å»ºä¸‹è½½URL
        DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.TAG_NAME }}/bob-plugin-openai-tts.bobplugin"

        # è·å–SHA256
        SHA256="${{ steps.sha256.outputs.SHA256 }}"

        # åˆ›å»ºæ–°çš„ç‰ˆæœ¬æ¡ç›®JSON
        NEW_VERSION_JSON=$(jq -n \
          --arg version "$VERSION_NUMBER" \
          --arg desc "ç‰ˆæœ¬ $VERSION_NUMBER å‘å¸ƒ" \
          --arg sha256 "$SHA256" \
          --arg url "$DOWNLOAD_URL" \
          --arg minBobVersion "1.8.0" \
          --argjson timestamp "$TIMESTAMP" \
          '{
            version: $version,
            desc: $desc,
            sha256: $sha256,
            url: $url,
            minBobVersion: $minBobVersion,
            timestamp: $timestamp
          }')

        # æ›´æ–°appcast.json
        if [ -f appcast.json ]; then
          # å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œæ·»åŠ æ–°ç‰ˆæœ¬åˆ°å¼€å¤´ï¼Œå¹¶ç§»é™¤é‡å¤ç‰ˆæœ¬
          jq --argjson newVersion "$NEW_VERSION_JSON" \
             --arg currentVersion "$VERSION_NUMBER" \
             '.versions = [$newVersion] + (.versions | map(select(.version != $currentVersion)))' \
             appcast.json > appcast_temp.json && mv appcast_temp.json appcast.json
        else
          # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°æ–‡ä»¶
          jq -n \
             --argjson newVersion "$NEW_VERSION_JSON" \
             '{
               identifier: "com.emcck.bob.tts",
               versions: [$newVersion]
             }' > appcast.json
        fi

        echo "Updated appcast.json with version $VERSION_NUMBER"

    - name: Commit and push appcast.json
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Auto-update appcast.json for ${{ steps.get_version.outputs.VERSION }}"
        file_pattern: appcast.json
        commit_user_name: GitHub Action
        commit_user_email: action@github.com
        commit_author: GitHub Action <action@github.com>
        skip_dirty_check: false

    - name: Output release info
      run: |
        echo "âœ… Release created successfully!"
        echo "ğŸ“¦ Plugin file: bob-plugin-openai-tts.bobplugin"
        echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.TAG_NAME }}"
        echo "ğŸ” SHA256: ${{ steps.sha256.outputs.SHA256 }}"
